alias: Switched Motion Turn On Lights
initial_state: false
trigger:
- platform: mqtt
  topic: 'zigbee2mqtt/#'
condition:
  condition: and
  conditions:
    - condition: template
      value_template: "{{ '_motion' in trigger.topic.split('/')[1] }}"
    - condition: template
      value_template: "{{ trigger.payload_json.occupancy == true }}"
    - condition: or
      conditions:
      - condition: state
        entity_id: binary_sensor.night
        state: 'on'
      - condition: template
        value_template: "{{ states( 'sensor.' + trigger.topic.split('/')[1] | replace ('_motion','_lux') ) < states( 'input_number.' + trigger.topic.split('/')[1] | replace ('_motion','_lux_limit') ) }}"
action:
- service: light.turn_on
  data_template:
    entity_id: "light.{{ trigger.topic.split('/')[1] | replace ('_motion','') }}"
    brightness_pct: >
      {% set hour=states("sensor.time").split(':')[0] | int %}
      {% if hour >= 5 and hour < 8 %}
        30
      {% elif hour >= 8 and hour <21 %}
        100
      {% elif hour >= 21 and hour <24 %}
        10
      {% else %}
        1
      {% endif %}
    transition: 1
- service: timer.cancel
  data_template:
    entity_id: "timer.{{ trigger.topic.split('/')[1] | replace ('_motion','') }}"
- service: timer.start
  data_template:
    entity_id: "timer.{{ trigger.topic.split('/')[1] | replace ('_motion','') }}"
    duration: "00:{{ states('input_number.' + trigger.topic.split('/')[1] | replace ('_motion','_timeout')) }}:00"