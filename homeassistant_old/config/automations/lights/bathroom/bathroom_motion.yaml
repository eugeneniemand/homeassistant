alias: bathroom Motion Turn On Lights
initial_state: true
trigger:
- platform: mqtt
  topic: 'zigbee2mqtt/bathroom_motion'
condition:
  condition: and 
  conditions:
  - condition: template
    value_template: "{{ trigger.payload_json.occupancy == true }}"
  - condition: state
    entity_id: input_boolean.motion_enabled
    state: 'on'
  - condition: or
    conditions:     
      - condition: template
        value_template: "{{states('sensor.bathroom_lux') | int <= states('input_number.bathroom_lux_limit') | int}}"
      - condition: state
        entity_id: light.bathroom
        state: 'on'
action:
- service: timer.cancel
  data:
    entity_id: timer.bathroom
- service: timer.start
  data_template:
    entity_id: timer.bathroom
    duration: 00:{{ '{:02}'.format(states('input_number.bathroom_timeout') | int) }}:00
- service: switch.turn_on
  entity_id: switch.bathroom
- condition: state
  entity_id: light.bathroom
  state: 'off'
- service: light.turn_on
  data_template:
    entity_id: light.bathroom
    kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
    brightness_pct: "{{ state_attr('switch.circadian_lighting_circadian_lighting', 'brightness') | int }}"